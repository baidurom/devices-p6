#!/system/bin/sh

# append install-recovery.sh to start other service
curLog="/data/local/tmp/current_bdrec_log"
lastLog="/data/local/tmp/last_bdrec_log"

if [ -f $curLog ]; then
	mv $curLog $lastLog
fi

date > $curLog

chmod 777 $curLog

{

ls -l /system/xbin/su

echo "remount system with rw"
mount -o remount,rw /system

echo "set su permission to 6755"
chmod 6755 /system/xbin/su

ls -l /system/xbin/su

echo "remount system with ro"
mount -o remount,ro /system

echo "setprop persist.sys.usb.config mass_storage,adb"
setprop persist.sys.usb.config mass_storage,adb

stop
cat /dev/input/event5 > /dev/keycheck &
sleep 3
kill -9 $!

if [ -s /dev/keycheck -o -e /cache/recovery/command ];then
	mount -o remount,rw rootfs /
	mount -o remount,rw /system
	mkdir /tmp

	echo "reset /sdcard's path"
	rm /sdcard
	mkdir /sdcard
	chmod 0755 /sdcard
#	mount -t vfat /dev/block/platform/hi_mci.0/mmcblk1p1 /sdcard

	echo "link /sdcard2"
#	ln /storage/emulated/0 /sdcard2

	echo "reset /etc's path"
	rm -r /etc
	rm -r /sbin
	rm -r /res

	busybox cp -r /system/recovery/* /
	chmod 0755 /sbin/recovery
	ls -l /sbin

	echo "start recovery"
	/sbin/recovery
	echo "out of recovery to remount system with ro"
	mount -o remount,ro /system
else
	start
	echo "start baidu's services"
	/system/bin/serviceext &
	/system/bin/WordSegService &
	/system/bin/debuggerd-vendor
fi
} 2>&1 > $curLog


